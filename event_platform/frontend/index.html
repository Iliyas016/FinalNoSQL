<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EventTicketing System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .page { display: none; } 
        .active { display: block; } 
        .nav-link { cursor: pointer; }
        .event-card { transition: 0.3s; border-radius: 10px; }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand fw-bold">EventPro</span>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" onclick="showPage('home')">Home</a>
                <a id="navReg" class="nav-link" onclick="showPage('register')">Register</a>
                <a id="navLogin" class="nav-link" onclick="showPage('login')">Login</a>
                <a id="navAdmin" class="nav-link text-warning" onclick="showPage('admin')" style="display:none;">Admin Panel</a>
                <a id="navStats" class="nav-link text-info" onclick="showPage('stats')" style="display:none;">Analytics</a>
                <a id="navLogout" class="nav-link text-danger" onclick="logout()" style="display:none;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="register" class="page card p-4 mx-auto" style="max-width: 400px;">
            <h3>Create Account</h3>
            <input id="regUser" class="form-control mb-2" placeholder="Username">
            <input id="regPass" type="password" class="form-control mb-3" placeholder="Password">
            <button class="btn btn-primary w-100" onclick="handleRegister()">Sign Up</button>
        </div>

        <div id="login" class="page active card p-4 mx-auto" style="max-width: 400px;">
            <h3>Sign In</h3>
            <input id="logUser" class="form-control mb-2" placeholder="Username">
            <input id="logPass" type="password" class="form-control mb-3" placeholder="Password">
            <button class="btn btn-dark w-100" onclick="handleLogin()">Login</button>
        </div>

        <div id="home" class="page">
            <h2 class="mb-4">Upcoming Events</h2>
            <div id="eventList" class="row"></div>
        </div>

        <div id="details" class="page card p-4 shadow-sm">
            <h2 id="detTitle" class="fw-bold"></h2>
            <p id="detDate" class="text-muted"></p>
            <div id="buyArea" class="my-3"></div>
            <hr>
            <h4>Reviews</h4>
            <div id="revList" class="mb-3"></div>
            <div class="input-group">
                <input id="revText" class="form-control" placeholder="Write a review...">
                <button class="btn btn-primary" onclick="addReview()">Post</button>
            </div>
        </div>

        <div id="admin" class="page">
            <div class="card p-4 mb-4 shadow-sm">
                <h3>Create New Event</h3>
                <div class="row g-2">
                    <div class="col-md-4"><input id="title" class="form-control" placeholder="Event Name"></div>
                    <div class="col-md-3"><input id="cat" class="form-control" placeholder="Category"></div>
                    <div class="col-md-3"><input id="dateInput" type="date" class="form-control"></div>
                    <div class="col-md-2"><input id="price" type="number" class="form-control" placeholder="Price"></div>
                </div>
                <button class="btn btn-success mt-3 w-100" onclick="saveEvent()">Save Event</button>
            </div>
            <h3>Manage Events</h3>
            <div id="adminList" class="list-group shadow-sm"></div>
        </div>

        <div id="stats" class="page card p-4 shadow-sm">
            <h3>Revenue by Category</h3>
            <div id="statBox" class="mt-3"></div>
        </div>
    </div>

    <script>
        const API = "http://127.0.0.1:8000";
        let curId = null;

        function updateUI(role) {
            const isLogged = !!role;
            const isAdmin = role === 'admin';
            document.getElementById('navAdmin').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('navStats').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('navLogout').style.display = isLogged ? 'block' : 'none';
            document.getElementById('navReg').style.display = isLogged ? 'none' : 'block';
            document.getElementById('navLogin').style.display = isLogged ? 'none' : 'block';
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'home') loadEvents();
            if(id === 'stats') loadStats();
            if(id === 'admin') loadAdminEvents();
        }

        async function handleRegister() {
            const user = { username: document.getElementById('regUser').value, password: document.getElementById('regPass').value };
            await fetch(`${API}/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(user)});
            alert("Account created!"); showPage('login');
        }

        async function handleLogin() {
            const user = { username: document.getElementById('logUser').value, password: document.getElementById('logPass').value };
            const res = await fetch(`${API}/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(user)});
            if(res.ok) {
                const data = await res.json();
                localStorage.setItem('token', data.token);
                localStorage.setItem('role', data.role);
                localStorage.setItem('user', data.username);
                updateUI(data.role);
                showPage('home');
            } else { alert("Wrong login or password"); }
        }

        async function loadEvents() {
            const res = await fetch(`${API}/events`);
            const data = await res.json();
            document.getElementById('eventList').innerHTML = data.map(e => `
                <div class="col-md-4 mb-3">
                    <div class="card p-3 event-card h-100 shadow-sm">
                        <span class="badge bg-primary mb-2" style="width:fit-content">${e.category}</span>
                        <h5>${e.title}</h5>
                        <p class="text-muted small mb-3">ðŸ“… Date: ${e.date}</p>
                        <button class="btn btn-outline-primary btn-sm mt-auto" onclick="view('${e._id}')">Details</button>
                    </div>
                </div>`).join('');
        }

        async function view(id) {
            curId = id;
            const res = await fetch(`${API}/events/${id}`);
            const e = await res.json();
            document.getElementById('detTitle').innerText = e.title;
            document.getElementById('detDate').innerText = "Event Date: " + e.date;
            
            const token = localStorage.getItem('token');
            const buyArea = document.getElementById('buyArea');
            if (token) {
                buyArea.innerHTML = `<button class="btn btn-success px-4" onclick="buy()">Buy Ticket ($${e.tickets[0].price})</button>`;
            } else {
                buyArea.innerHTML = `<div class="alert alert-warning">Please login to purchase tickets.</div>`;
            }

            document.getElementById('revList').innerHTML = e.reviews.map(r => 
                `<p class="border-bottom p-1"><b>${r.user}:</b> ${r.comment}</p>`
            ).join('');
            showPage('details');
        }

        async function buy() {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API}/purchase/${curId}?ticket_type=General`, {
                method:'POST', headers: {'Authorization': `Bearer ${token}`}
            });
            if(res.ok) { alert("Ticket purchased!"); view(curId); }
            else { alert("Purchase failed. Try logging in again."); }
        }

        async function addReview() {
            const user = localStorage.getItem('user') || 'Guest';
            const rev = { user: user, comment: document.getElementById('revText').value };
            await fetch(`${API}/events/${curId}/review`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(rev)});
            document.getElementById('revText').value = ""; view(curId);
        }

        async function saveEvent() {
            const ev = { 
                title: document.getElementById('title').value, 
                category: document.getElementById('cat').value,
                date: document.getElementById('dateInput').value,
                tickets: [{type:"General", price: parseFloat(document.getElementById('price').value), sold: 0}]
            };
            const token = localStorage.getItem('token');
            await fetch(`${API}/events`, { 
                method:'POST', headers:{'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, body:JSON.stringify(ev)
            });
            showPage('home');
        }

        async function loadAdminEvents() {
            const res = await fetch(`${API}/events`);
            const data = await res.json();
            document.getElementById('adminList').innerHTML = data.map(e => `
                <div class="list-group-item d-flex justify-content-between p-3 align-items-center">
                    <div><b>${e.title}</b> <br> <small class="text-muted">${e.date}</small></div>
                    <button class="btn btn-danger btn-sm" onclick="delEvent('${e._id}')">Delete</button>
                </div>`).join('');
        }

        async function delEvent(id) {
            const token = localStorage.getItem('token');
            await fetch(`${API}/events/${id}`, { method:'DELETE', headers:{'Authorization': `Bearer ${token}`} });
            loadAdminEvents();
        }

        async function loadStats() {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API}/stats`, { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            document.getElementById('statBox').innerHTML = data.map(s => `
                <div class="d-flex justify-content-between p-2 border-bottom">
                    <b>${s._id}</b> <span>$${s.total_rev.toFixed(2)}</span>
                </div>`).join('');
        }

        function logout() { localStorage.clear(); updateUI(null); showPage('login'); }

        window.onload = () => {
            const role = localStorage.getItem('role');
            if(role) updateUI(role);
        };
    </script>
</body>
</html>